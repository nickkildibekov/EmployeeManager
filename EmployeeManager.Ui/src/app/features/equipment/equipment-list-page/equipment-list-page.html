<div class="container">
  <div class="header">
    <h2>Equipment</h2>
    <button class="btn btn-primary" (click)="toggleAddForm()" *ngIf="!isAddFormVisible()">
      + Add Equipment
    </button>
  </div>

  <div *ngIf="error()" class="alert alert-danger">
    {{ error() }}
  </div>

  <!-- Add Form -->
  <div *ngIf="isAddFormVisible()" class="add-form">
    <!-- Row 1: Name | Serial | Description -->
    <div class="form-row row-1">
      <input class="form-control" placeholder="Equipment Name" [(ngModel)]="newEquipment().name" />
      <input
        class="form-control"
        placeholder="Serial Number (Optional)"
        [(ngModel)]="newEquipment().serialNumber"
      />
      <input
        class="form-control"
        placeholder="Description"
        [(ngModel)]="newEquipment().description"
      />
    </div>

    <!-- Row 2: Purchase Date | Department | Category/+NewCategoryButton -->
    <div class="form-row row-2">
      <input
        class="form-control"
        type="date"
        placeholder="Purchase Date"
        [(ngModel)]="newEquipment().purchaseDate"
      />
      <select class="form-control" [(ngModel)]="newEquipment().departmentId">
        <option [ngValue]="null" disabled>Select Department</option>
        <option *ngFor="let dep of departments()" [ngValue]="dep.id">
          {{ dep.name }}
        </option>
      </select>

      @if (!isAddingNewCategory()) {
      <div class="select-with-button">
        <select class="form-control" [(ngModel)]="newEquipment().categoryId">
          <option [ngValue]="null" disabled>Select Category</option>
          <option *ngFor="let cat of categories()" [ngValue]="cat.id">
            {{ cat.name }}
          </option>
        </select>
        <button class="btn btn-secondary" type="button" (click)="toggleAddNewCategory()">
          + New Category
        </button>
      </div>
      } @else {
      <div class="inline-form-vertical">
        <input class="form-control" placeholder="Category Name" [(ngModel)]="newCategoryName" />
        <input
          class="form-control"
          placeholder="Description (optional)"
          [(ngModel)]="newCategoryDescription"
        />
        <div class="button-stack">
          <button class="btn btn-success" type="button" (click)="createAndSelectCategory()">
            Create
          </button>
          <button class="btn btn-secondary" type="button" (click)="toggleAddNewCategory()">
            Cancel
          </button>
        </div>
      </div>
      }
    </div>

    <!-- Row 3: Status Radios | Measurement Radios | Amount -->
    <div class="form-row row-3">
      <div class="status-group">
        <label>Status</label>
        <div class="status-options">
          <label class="status-option">
            <input
              type="radio"
              name="new-status"
              [value]="'Used'"
              [(ngModel)]="newEquipment().status"
            />
            Used
          </label>
          <label class="status-option">
            <input
              type="radio"
              name="new-status"
              [value]="'NotUsed'"
              [(ngModel)]="newEquipment().status"
            />
            Not Used
          </label>
          <label class="status-option">
            <input
              type="radio"
              name="new-status"
              [value]="'Broken'"
              [(ngModel)]="newEquipment().status"
            />
            Broken
          </label>
        </div>
      </div>

      <div class="measurement-group">
        <label>Measurement</label>
        <div class="measurement-options">
          <label class="measurement-option">
            <input
              type="radio"
              name="new-measurement"
              [value]="'Unit'"
              [(ngModel)]="newEquipment().measurement"
              (change)="onMeasurementChange('Unit')"
            />
            Unit
          </label>
          <label class="measurement-option">
            <input
              type="radio"
              name="new-measurement"
              [value]="'Meter'"
              [(ngModel)]="newEquipment().measurement"
              (change)="onMeasurementChange('Meter')"
            />
            Meter
          </label>
          <label class="measurement-option">
            <input
              type="radio"
              name="new-measurement"
              [value]="'Liter'"
              [(ngModel)]="newEquipment().measurement"
              (change)="onMeasurementChange('Liter')"
            />
            Liter
          </label>
        </div>
      </div>

      <div class="amount-group">
        <label>
          Amount
          <span class="unit-hint">
            (
            {{
              newEquipment().measurement === 'Unit'
                ? 'Unit'
                : newEquipment().measurement === 'Meter'
                ? 'm'
                : 'L'
            }}
            )
          </span>
        </label>
        <input
          class="form-control"
          type="number"
          [step]="newEquipment().measurement === 'Unit' ? 1 : 0.01"
          [min]="newEquipment().measurement === 'Unit' ? 1 : 0.01"
          inputmode="numeric"
          (input)="onAmountInput($event)"
          [(ngModel)]="newEquipment().amount"
          placeholder="Amount"
        />
      </div>
    </div>

    <!-- Row 4: Image Upload -->
    <div class="form-row row-4">
      <div class="image-group">
        <label>Equipment Image (Optional)</label>
        <input
          type="file"
          accept="image/*"
          class="form-control"
          (change)="onImageSelected($event)"
        />
        @if (newEquipment().imageData) {
        <div class="image-preview">
          <img [src]="newEquipment().imageData" alt="Equipment preview" class="preview-img" />
          <button type="button" class="btn btn-sm btn-secondary" (click)="clearImage()">
            Remove Image
          </button>
        </div>
        }
      </div>
    </div>

    <!-- Row 5: Create/Cancel buttons -->
    <div class="button-row">
      <button class="btn btn-success" (click)="addEquipment()" [disabled]="!isFormValid()">
        Create
      </button>
      <button class="btn btn-secondary" (click)="cancelAdd()">Cancel</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <select class="filter-select" (change)="onDepartmentChange($event.target.value)">
      <option value="">All Departments</option>
      <option *ngFor="let dept of departments()" [value]="dept.id">
        {{ dept.name }}
      </option>
    </select>
    <select class="filter-select" (change)="onCategoryChange($event.target.value)">
      <option value="">All Categories</option>
      <option *ngFor="let cat of categories()" [value]="cat.id">
        {{ cat.name }}
      </option>
    </select>
    <select class="filter-select" (change)="onStatusChange($event.target.value)">
      <option value="all">All Statuses</option>
      <option value="used">Used</option>
      <option value="not_used">Not Used</option>
      <option value="broken">Broken</option>
    </select>
    <input
      type="text"
      class="filter-search"
      placeholder="Search by name..."
      (keyup)="onSearch($event.target.value)"
    />
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
  <app-skeleton-loader [count]="5"></app-skeleton-loader>
  }

  <!-- List -->
  <div *ngIf="!isLoading()" class="table-container">
    <div *ngIf="equipment().length === 0" class="empty-message">No equipment found.</div>

    <table *ngIf="equipment().length > 0" class="equipment-table">
      <thead>
        <tr>
          <th class="sortable" (click)="toggleSort('name')">
            Name
            <span class="sort-indicator" *ngIf="sortBy() === 'name'">
              {{ sortOrder() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>
          <th class="sortable" (click)="toggleSort('serialNumber')">
            Serial Number
            <span class="sort-indicator" *ngIf="sortBy() === 'serialNumber'">
              {{ sortOrder() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>
          <th class="sortable" (click)="toggleSort('category')">
            Category
            <span class="sort-indicator" *ngIf="sortBy() === 'category'">
              {{ sortOrder() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>
          <th class="sortable" (click)="toggleSort('purchaseDate')">
            Purchase Date
            <span class="sort-indicator" *ngIf="sortBy() === 'purchaseDate'">
              {{ sortOrder() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>
          <th class="sortable" (click)="toggleSort('status')">
            Status
            <span class="sort-indicator" *ngIf="sortBy() === 'status'">
              {{ sortOrder() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>
          <th class="sortable" (click)="toggleSort('department')">
            Department
            <span class="sort-indicator" *ngIf="sortBy() === 'department'">
              {{ sortOrder() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>
          <th class="sortable" (click)="toggleSort('amount')">
            Amount
            <span class="sort-indicator" *ngIf="sortBy() === 'amount'">
              {{ sortOrder() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>
          <th>Image</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of equipment()" class="table-row" (click)="openEquipment(item.id)">
          <td>{{ item.name }}</td>
          <td>{{ item.serialNumber }}</td>
          <td>{{ item.categoryName || 'N/A' }}</td>
          <td>{{ item.purchaseDate | date : 'MMM dd, yyyy' }}</td>
          <td>
            <span
              class="status-badge"
              [ngClass]="{
                'status-used': item.status === 'Used',
                'status-not-used': item.status === 'NotUsed',
                'status-broken': item.status === 'Broken'
              }"
            >
              {{
                item.status === 'Used' ? 'Used' : item.status === 'NotUsed' ? 'Not Used' : 'Broken'
              }}
            </span>
          </td>
          <td>{{ item.departmentName || 'N/A' }}</td>
          <td>{{ item.amount }}</td>
          <td>
            @if (item.imageData) {
            <img
              [src]="item.imageData"
              [alt]="item.name + ' thumbnail'"
              class="table-image"
              (click)="openImageModal(item.imageData, item.name); $event.stopPropagation()"
            />
            } @else {
            <div class="table-image-placeholder">No Image</div>
            }
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div *ngIf="equipment().length > 0" class="pagination">
    <button class="btn btn-sm" (click)="changePage(page() - 1)" [disabled]="page() === 1">
      ← Previous
    </button>
    <span class="page-info">
      Page {{ page() }} of {{ Math.ceil(total() / pageSize()) }} (Total: {{ total() }})
    </span>
    <button
      class="btn btn-sm"
      (click)="changePage(page() + 1)"
      [disabled]="page() >= Math.ceil(total() / pageSize())"
    >
      Next →
    </button>
  </div>

  <!-- Image Modal -->
  @if (selectedImage()) {
  <div class="modal-backdrop" (click)="closeImageModal()">
    <div class="modal-content fixed" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeImageModal()" aria-label="Close">✕</button>
      <div class="modal-image-wrap">
        <button class="modal-nav prev" (click)="prevImage()" aria-label="Previous">‹</button>
        <img [src]="selectedImage()!.src" [alt]="selectedImage()!.name" class="modal-image" />
        <button class="modal-nav next" (click)="nextImage()" aria-label="Next">›</button>
      </div>
      <div class="modal-caption">
        <span class="caption-text">{{ selectedImage()!.name }}</span>
        <button class="modal-action" (click)="openSelectedDetails()">Open details</button>
      </div>
    </div>
  </div>
  }
</div>
