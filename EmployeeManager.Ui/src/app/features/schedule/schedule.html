<div class="rct-outer">
  <!-- Top Controls Bar -->
  <div class="rct-controls">
    <div class="rct-controls-left">
      <h2>Schedule</h2>
      <select [ngModel]="selectedDepartmentId()" (ngModelChange)="onDepartmentChange($event.toString())" class="rct-select">
        <option *ngFor="let dept of departments()" [value]="dept.id">{{ dept.name }}</option>
      </select>
    </div>
    <div class="rct-controls-right">
      <div class="rct-legend">
        <span class="rct-legend-item"><span class="rct-dot work"></span>Working</span>
        <span class="rct-legend-item"><span class="rct-dot vacation"></span>Vacation</span>
        <span class="rct-legend-item"><span class="rct-dot illness"></span>Illness</span>
        <span class="rct-legend-item"><span class="rct-dot rest"></span>Rest</span>
      </div>
      <button class="rct-btn" (click)="exportToCSV()">Export CSV</button>
    </div>
  </div>


  <!-- Timeline Container -->
  <div class="rct-container">
    @if (isLoading()) {
      <div class="rct-loading">Loading...</div>
    } @else if (errorMessage()) {
      <div class="rct-error">{{ errorMessage() }}</div>
    } @else {
      <div class="rct-scroll-wrapper">
        <div class="rct-timeline">
          <!-- Left Sidebar: Employee Names -->
          <div class="rct-sidebar">
            <div class="rct-sidebar-header">Employees</div>
            <div class="rct-sidebar-body">
              <div *ngFor="let emp of filteredEmployees(); trackBy: trackByEmployeeId" class="rct-row-label">
                <div class="rct-emp-name">{{ emp.firstName }} {{ emp.lastName }}</div>
                <div class="rct-emp-position">{{ emp.positionName || 'No Position' }}</div>
              </div>
            </div>
          </div>

          <!-- Right: Timeline Grid -->
          <div class="rct-grid-wrapper">
            <!-- Date Headers -->
            <div class="rct-header">
              <div *ngFor="let col of timelineColumns(); trackBy: trackByColumn; let i = index" 
                   class="rct-header-cell"
                   [style.width.px]="cellWidth">
                <div class="rct-date-label">
                  <span class="rct-day">{{ col | date: 'EEE' }}</span>
                  <span class="rct-num">{{ col | date: 'd' }}</span>
                  <span class="rct-month">{{ col | date: 'MMM' }}</span>
                </div>
              </div>
            </div>

            <!-- Grid Body with Rows -->
            <div class="rct-body">
              <div *ngFor="let emp of filteredEmployees(); trackBy: trackByEmployeeId" class="rct-row">
                <div class="rct-row-inner">
                  <!-- Grid cells for each date -->
                  <div *ngFor="let col of timelineColumns(); trackBy: trackByColumn; let i = index" 
                       class="rct-cell"
                       [style.width.px]="cellWidth"
                       (click)="onCellClick(emp.id, getIsoDate(col))"
                       (dragover)="onDragOver($event)"
                       (drop)="onDrop(getIsoDate(col), $event)">
                  </div>
                  
                  <!-- Entry Bars (absolute positioned) -->
                  <div class="rct-items-layer">
                    @for (col of timelineColumns(); track trackByColumn($index, col); let i = $index) {
                      @if (getEntry(emp.id, getIsoDate(col))?.hours > 0) {
                        <div class="rct-item"
                             [ngClass]="'state-' + getEntry(emp.id, getIsoDate(col))?.state?.toLowerCase()"
                             [style.left.px]="i * cellWidth"
                             [style.width.px]="cellWidth - 4"
                             (click)="onCellClick(emp.id, getIsoDate(col)); $event.stopPropagation()"
                             draggable="true"
                             (dragstart)="onDragStart(emp.id, getIsoDate(col), $event)">
                          <div class="rct-item-content">
                            <span class="rct-item-text">{{ getEntry(emp.id, getIsoDate(col))?.hours }}h</span>
                          </div>
                        </div>
                      }
                    }
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    }
  </div>
</div>


<!-- Edit Modal -->
@if (showEditModal()) {
  <div class="rct-modal-overlay" (click)="closeEditModal()">
    <div class="rct-modal" (click)="$event.stopPropagation()">
      <div class="rct-modal-header">
        <h3>Edit Entry</h3>
        <button class="rct-modal-close" (click)="closeEditModal()">Ã—</button>
      </div>
      <div class="rct-modal-body">
        <div class="rct-form-group">
          <label>Hours (0-24)</label>
          <input type="number" 
                 min="0" 
                 max="24" 
                 #hoursInput
                 [value]="getEditingEntry()?.hours || 0" 
                 class="rct-input">
        </div>
        <div class="rct-form-group">
          <label>Status</label>
          <select #stateSelect [value]="getEditingEntry()?.state || 'Rest'" class="rct-select">
            <option value="OnWork">Working</option>
            <option value="Vacation">Vacation</option>
            <option value="Illness">Illness</option>
            <option value="Rest">Rest</option>
          </select>
        </div>
      </div>
      <div class="rct-modal-footer">
        <button class="rct-btn rct-btn-secondary" (click)="closeEditModal()">Cancel</button>
        <button class="rct-btn rct-btn-primary" 
                (click)="updateEditingEntry(+hoursInput.value, stateSelect.value)">
          Save
        </button>
      </div>
    </div>
  </div>
}
