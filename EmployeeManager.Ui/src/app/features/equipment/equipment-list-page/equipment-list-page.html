<div class="container">
  <div class="header">
    <h2>–û–±–ª–∞–¥–Ω–∞–Ω–Ω—è</h2>
    <div class="header-buttons">
      <button class="btn btn-primary" (click)="openCategoriesManageModal()">
        ‚úèÔ∏è –†–ï–î–ê–ì–£–í–ê–¢–ò –ö–ê–¢–ï–ì–û–†–Ü–á
      </button>
      <button class="btn btn-primary" (click)="openEquipmentModal()">
        + –î–û–î–ê–¢–ò –û–ë–õ–ê–î–ù–ê–ù–ù–Ø
      </button>
    </div>
  </div>

  <div *ngIf="error()" class="alert alert-danger">
    {{ error() }}
  </div>

  <!-- Filters -->
  <div class="filters">
    <select class="filter-select" (change)="onDepartmentChange($event.target.value)">
      <option value="">–í—Å—ñ –≤—ñ–¥–¥—ñ–ª–∏</option>
      <option *ngFor="let dept of departments()" [value]="dept.id">
        {{ dept.name }}
      </option>
    </select>
    <select class="filter-select" (change)="onCategoryChange($event.target.value)">
      <option value="">–í—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>
      <option *ngFor="let cat of categories()" [value]="cat.id">
        {{ cat.name }}
      </option>
    </select>
    <select class="filter-select" (change)="onStatusChange($event.target.value)">
      <option value="all">–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option>
      <option value="used">–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è</option>
      <option value="not_used">–ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è</option>
      <option value="broken">–ü–æ—à–∫–æ–¥–∂–µ–Ω–æ</option>
    </select>
    <input
      type="text"
      class="filter-search"
      placeholder="–ü–æ—à—É–∫ –∑–∞ –Ω–∞–∑–≤–æ—é..."
      (keyup)="onSearch($event.target.value)"
    />
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
  <app-skeleton-loader [count]="5"></app-skeleton-loader>
  }

  <!-- List -->
  <div *ngIf="!isLoading()" class="table-container">
    <div *ngIf="equipment().length === 0" class="empty-message">–û–±–ª–∞–¥–Ω–∞–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</div>

    <table *ngIf="equipment().length > 0" class="equipment-table">
      <thead>
        <tr>
          <th class="sortable" (click)="toggleSort('name')">
            –ù–∞–∑–≤–∞
            <span class="sort-indicator" *ngIf="sortBy() === 'name'">
              {{ sortOrder() === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
          </th>
          <th class="sortable" (click)="toggleSort('serialNumber')">
            –°–µ—Ä—ñ–π–Ω–∏–π –Ω–æ–º–µ—Ä
            <span class="sort-indicator" *ngIf="sortBy() === 'serialNumber'">
              {{ sortOrder() === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
          </th>
          <th class="sortable" (click)="toggleSort('category')">
            –ö–∞—Ç–µ–≥–æ—Ä—ñ—è
            <span class="sort-indicator" *ngIf="sortBy() === 'category'">
              {{ sortOrder() === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
          </th>
          <th class="sortable" (click)="toggleSort('purchaseDate')">
            –î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏
            <span class="sort-indicator" *ngIf="sortBy() === 'purchaseDate'">
              {{ sortOrder() === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
          </th>
          <th class="sortable" (click)="toggleSort('status')">
            –°—Ç–∞—Ç—É—Å
            <span class="sort-indicator" *ngIf="sortBy() === 'status'">
              {{ sortOrder() === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
          </th>
          <th class="sortable" (click)="toggleSort('department')">
            –í—ñ–¥–¥—ñ–ª
            <span class="sort-indicator" *ngIf="sortBy() === 'department'">
              {{ sortOrder() === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
          </th>
          <th class="sortable" (click)="toggleSort('amount')">
            –ö—ñ–ª—å–∫—ñ—Å—Ç—å
            <span class="sort-indicator" *ngIf="sortBy() === 'amount'">
              {{ sortOrder() === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
          </th>
          <th>–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è</th>
          <th>–î—ñ—ó</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of equipment()" class="table-row" (click)="openEquipment(item.id)">
          <td>{{ item.name }}</td>
          <td>{{ item.serialNumber }}</td>
          <td>{{ item.categoryName || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ' }}</td>
          <td>{{ item.purchaseDate | date : 'MMM dd, yyyy' }}</td>
          <td>
            <span
              class="status-badge"
              [ngClass]="{
                'status-used': item.status === 'Used',
                'status-not-used': item.status === 'NotUsed',
                'status-broken': item.status === 'Broken'
              }"
            >
              {{
                item.status === 'Used' ? '–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è' : item.status === 'NotUsed' ? '–ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è' : '–ü–æ—à–∫–æ–¥–∂–µ–Ω–æ'
              }}
            </span>
          </td>
          <td>{{ item.departmentName || '–°–∫–ª–∞–¥' }}</td>
          <td>{{ item.amount }}</td>
          <td>
            @if (item.imageData) {
            <img
              [src]="item.imageData"
              [alt]="item.name + ' –º—ñ–Ω—ñ–∞—Ç—é—Ä–∞'"
              class="table-image"
              (click)="openImageModal(item.imageData, item.name); $event.stopPropagation()"
            />
            } @else {
            <div class="table-image-placeholder">–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–µ–º–∞—î</div>
            }
          </td>
          <td>
            <div class="action-buttons" (click)="$event.stopPropagation()">
              <button
                class="btn-icon btn-edit"
                (click)="editEquipment(item)"
                title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è"
                aria-label="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è"
              >
                ‚úèÔ∏è
              </button>
              <button
                class="btn-icon btn-delete"
                (click)="deleteEquipment(item.id)"
                title="–í–∏–¥–∞–ª–∏—Ç–∏ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è"
                aria-label="–í–∏–¥–∞–ª–∏—Ç–∏ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è"
              >
                üóëÔ∏è
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div *ngIf="equipment().length > 0" class="pagination">
    <button class="btn btn-sm" (click)="changePage(page() - 1)" [disabled]="page() === 1">
      ‚Üê –ü–æ–ø–µ—Ä–µ–¥–Ω—è
    </button>
    <span class="page-info">
      –°—Ç–æ—Ä—ñ–Ω–∫–∞ {{ page() }} –∑ {{ Math.ceil(total() / pageSize()) }} (–í—Å—å–æ–≥–æ: {{ total() }})
    </span>
    <button
      class="btn btn-sm"
      (click)="changePage(page() + 1)"
      [disabled]="page() >= Math.ceil(total() / pageSize())"
    >
      –ù–∞—Å—Ç—É–ø–Ω–∞ ‚Üí
    </button>
  </div>

  <!-- Image Modal -->
  @if (selectedImage()) {
  <div class="modal-backdrop" (click)="closeImageModal()">
    <div class="modal-content fixed" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeImageModal()" aria-label="–ó–∞–∫—Ä–∏—Ç–∏">‚úï</button>
      <div class="modal-image-wrap">
        <button class="modal-nav prev" (click)="prevImage()" aria-label="–ü–æ–ø–µ—Ä–µ–¥–Ω—î">‚Äπ</button>
        <img [src]="selectedImage()!.src" [alt]="selectedImage()!.name" class="modal-image" />
        <button class="modal-nav next" (click)="nextImage()" aria-label="–ù–∞—Å—Ç—É–ø–Ω–µ">‚Ä∫</button>
      </div>
      <div class="modal-caption">
        <span class="caption-text">{{ selectedImage()!.name }}</span>
        <button class="modal-action" (click)="openSelectedDetails()">–í—ñ–¥–∫—Ä–∏—Ç–∏ –¥–µ—Ç–∞–ª—ñ</button>
      </div>
    </div>
  </div>
  }

  <!-- Equipment Modal -->
  <app-equipment-modal
    [isOpen]="isEquipmentModalOpen"
    [equipment]="selectedEquipment()"
    [departments]="departments()"
    [categories]="categories()"
    [employees]="employees()"
    (save)="onEquipmentSave($event)"
    (close)="closeEquipmentModal()"
    (categoryAdded)="onCategoryAdded($event)"
  />

  <!-- Categories Manage Modal -->
  <app-equipment-categories-manage-modal
    [isOpen]="isCategoriesManageModalOpen"
    [categories]="categories()"
    (close)="closeCategoriesManageModal()"
    (categoryDeleted)="onCategoryDelete($event)"
    (categoryUpdated)="onCategoryUpdated($event)"
  />
</div>
